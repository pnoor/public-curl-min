name: Build Minimal libcurl for Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64, x86]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y \
            build-essential \
            cmake \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            unzip

      - name: Set NDK path
        run: echo "ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME" >> $GITHUB_ENV

      - name: Download sources
        run: |
          wget -q https://curl.se/download/curl-8.11.0.tar.gz
          tar xzf curl-8.11.0.tar.gz
          wget -q https://www.openssl.org/source/openssl-3.4.0.tar.gz
          tar xzf openssl-3.4.0.tar.gz

      - name: Set toolchain variables
        id: tc
        run: |
          ABI=${{ matrix.abi }}
          TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64

          case $ABI in
            arm64-v8a)
              TARGET="aarch64-linux-android"
              SSL_TARGET="android-arm64"
              ;;
            armeabi-v7a)
              TARGET="armv7a-linux-androideabi"
              SSL_TARGET="android-arm"
              ;;
            x86_64)
              TARGET="x86_64-linux-android"
              SSL_TARGET="android-x86_64"
              ;;
            x86)
              TARGET="i686-linux-android"
              SSL_TARGET="android-x86"
              ;;
          esac

          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "SSL_TARGET=$SSL_TARGET" >> $GITHUB_OUTPUT
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_OUTPUT
          echo "CC=$TOOLCHAIN/bin/${TARGET}24-clang" >> $GITHUB_OUTPUT
          echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_OUTPUT
          echo "RANLIB=$TOOLCHAIN/bin/llvm-ranlib" >> $GITHUB_OUTPUT

      - name: Build OpenSSL minimal
        run: |
          export PATH="${{ steps.tc.outputs.TOOLCHAIN }}/bin:$PATH"

          mkdir -p output/openssl/${{ matrix.abi }}
          cd openssl-3.4.0

          ./Configure ${{ steps.tc.outputs.SSL_TARGET }} \
            -D__ANDROID_API__=24 \
            --prefix=$(pwd)/../output/openssl/${{ matrix.abi }} \
            no-shared \
            no-dso \
            no-engine \
            no-tests \
            no-apps \
            no-legacy \
            no-weak-ssl-ciphers \
            no-comp \
            no-srp \
            no-gost \
            no-dgram \
            no-dtls \
            no-camellia \
            no-seed \
            no-idea \
            no-bf \
            no-cast \
            no-md4 \
            no-rc2 \
            no-rc4 \
            no-des \
            no-dsa \
            no-dh \
            -Os -ffunction-sections -fdata-sections

          make -j$(nproc) build_sw
          make install_sw

      - name: Build libcurl HTTPS only
        run: |
          export PATH="${{ steps.tc.outputs.TOOLCHAIN }}/bin:$PATH"

          OPENSSL_OUT=$(pwd)/output/openssl/${{ matrix.abi }}
          mkdir -p output/curl/${{ matrix.abi }}
          cd curl-8.11.0

          autoreconf -fi

          ./configure \
            --host=${{ steps.tc.outputs.TARGET }} \
            CC="${{ steps.tc.outputs.CC }}" \
            AR="${{ steps.tc.outputs.AR }}" \
            RANLIB="${{ steps.tc.outputs.RANLIB }}" \
            CFLAGS="-Os -ffunction-sections -fdata-sections -fvisibility=hidden" \
            LDFLAGS="-Wl,--gc-sections" \
            LIBS="-lz" \
            --prefix=$(pwd)/../output/curl/${{ matrix.abi }} \
            --with-openssl="$OPENSSL_OUT" \
            --disable-shared \
            --enable-static \
            --enable-http \
            --disable-dict \
            --disable-file \
            --disable-ftp \
            --disable-gopher \
            --disable-imap \
            --disable-ldap \
            --disable-ldaps \
            --disable-mqtt \
            --disable-pop3 \
            --disable-rtsp \
            --disable-smb \
            --disable-smtp \
            --disable-telnet \
            --disable-tftp \
            --disable-websockets \
            --disable-manual \
            --disable-ipv6 \
            --disable-unix-sockets \
            --disable-doh \
            --disable-dateparse \
            --disable-progress-meter \
            --disable-netrc \
            --disable-ntlm \
            --without-nghttp2 \
            --without-libidn2 \
            --without-libpsl \
            --without-librtmp \
            --without-brotli \
            --without-zstd \
            --with-zlib

          make -j$(nproc)
          make install

      - name: Show sizes
        run: |
          echo "=== ${{ matrix.abi }} ==="
          du -h output/curl/${{ matrix.abi }}/lib/libcurl.a
          du -h output/openssl/${{ matrix.abi }}/lib/libssl.a
          du -h output/openssl/${{ matrix.abi }}/lib/libcrypto.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libs-${{ matrix.abi }}
          path: |
            output/curl/${{ matrix.abi }}/lib/libcurl.a
            output/openssl/${{ matrix.abi }}/lib/libssl.a
            output/openssl/${{ matrix.abi }}/lib/libcrypto.a
